<!-- Page Header -->
<div class="card">
  <orca-page-header
    title="Gestión de Clientes"
    description="Administra los clientes del sistema y sus configuraciones"
  >
  </orca-page-header>

  <!-- Statistics Cards -->
  <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6 px-4">
    <p-card class="text-center">
      <div class="flex flex-col items-center">
        <div class="text-2xl font-bold text-zinc-900 dark:text-white">
          {{ clientStats().total }}
        </div>
        <div class="text-sm text-zinc-600 dark:text-zinc-400">Total Clientes</div>
      </div>
    </p-card>

    <p-card class="text-center">
      <div class="flex flex-col items-center">
        <div class="text-2xl font-bold text-green-600">
          {{ clientStats().active }}
        </div>
        <div class="text-sm text-zinc-600 dark:text-zinc-400">Activas</div>
      </div>
    </p-card>

    <p-card class="text-center">
      <div class="flex flex-col items-center">
        <div class="text-2xl font-bold text-red-600">
          {{ clientStats().suspended }}
        </div>
        <div class="text-sm text-zinc-600 dark:text-zinc-400">Suspendidas</div>
      </div>
    </p-card>
  </div>
  <p-table
    #dt
    [value]="filteredClients()"
    [loading]="isLoading()"
    [paginator]="true"
    [rows]="10"
    [rowsPerPageOptions]="[10, 25, 50]"
    [showCurrentPageReport]="true"
    currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} clientes"
    [globalFilterFields]="['name', 'schemaName', 'domainUrl']"
    [tableStyle]="{ 'min-width': '75rem' }"
    [rowHover]="true"
    [stripedRows]="true"
    dataKey="id"
  >
    <ng-template pTemplate="caption">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-2">
          <p-button
            icon="pi pi-refresh"
            severity="secondary"
            outlined
            [rounded]="true"
            pTooltip="Actualizar listado"
            tooltipPosition="bottom"
            (onClick)="refreshClients()"
          />
          <p-button
            icon="pi pi-users"
            severity="secondary"
            outlined
            [rounded]="true"
            pTooltip="Asignar usuarios a clientes"
            tooltipPosition="bottom"
            (onClick)="openAssignClientsModal()"
          />
        </div>

        <div class="flex items-center gap-4">
          <p-iconfield>
            <p-inputicon class="pi pi-search" />
            <input
              pInputText
              type="text"
              (input)="dt.filterGlobal($event.target.value, 'contains')"
              placeholder="Buscar clientes..."
              class="w-80"
            />
          </p-iconfield>

          <p-select
            [options]="statusOptions"
            [ngModel]="selectedStatus()"
            (ngModelChange)="onStatusChange($event)"
            placeholder="Estado"
            optionLabel="label"
            optionValue="value"
            class="w-40"
          />

          <p-button label="Nuevo" icon="pi pi-plus" (onClick)="openCreateClientModal()" />
        </div>
      </div>
    </ng-template>
    <ng-template pTemplate="header">
      <tr>
        <th pSortableColumn="name" style="min-width: 12rem">
          <div class="flex items-center gap-2">
            Nombre
            <p-sortIcon field="name" />
          </div>
        </th>
        <th pSortableColumn="schemaName" style="min-width: 12rem">
          <div class="flex items-center gap-2">
            Schema
            <p-sortIcon field="schemaName" />
          </div>
        </th>
        <th pSortableColumn="domainUrl" style="min-width: 12rem">
          <div class="flex items-center gap-2">
            Dominio
            <p-sortIcon field="domainUrl" />
          </div>
        </th>
        <th pSortableColumn="status" style="min-width: 8rem">
          <div class="flex items-center gap-2">
            Estado
            <p-sortIcon field="status" />
          </div>
        </th>
        <th pSortableColumn="subscriptionStartDate" style="min-width: 14rem">
          <div class="flex items-center gap-2">
            Suscripción
            <p-sortIcon field="subscriptionStartDate" />
          </div>
        </th>
        <th pSortableColumn="createdAt" style="min-width: 10rem">
          <div class="flex items-center gap-2">
            Creada
            <p-sortIcon field="createdAt" />
          </div>
        </th>
        <th style="min-width: 5rem; width: 5rem" class="text-center">Acciones</th>
      </tr>
    </ng-template>

    <!-- Table Body -->
    <ng-template pTemplate="body" let-client let-ri="rowIndex">
      <tr>
        <!-- Client Name -->
        <td>
          <div class="flex flex-col">
            <span class="font-medium text-zinc-900 dark:text-white">
              {{ client.name }}
            </span>
            <span class="text-sm text-zinc-600 dark:text-zinc-400"> ID: {{ client.id }} </span>
          </div>
        </td>

        <!-- Schema Name -->
        <td>
          <div class="flex flex-col">
            <span class="font-mono text-sm text-zinc-900 dark:text-white">
              {{ client.schemaName }}
            </span>
            <span class="text-xs text-zinc-500 dark:text-zinc-400"> Base de datos </span>
          </div>
        </td>

        <!-- Domain URL -->
        <td>
          <div class="flex flex-col">
            <span class="text-zinc-900 dark:text-white">
              {{ client.domainUrl }}
            </span>
            <span class="text-xs text-zinc-500 dark:text-zinc-400"> .orcasns.com </span>
          </div>
        </td>

        <!-- Status -->
        <td>
          <p-tag
            [value]="getStatusLabel(client.status)"
            [severity]="getStatusSeverity(client.status)"
            [rounded]="true"
          >
          </p-tag>
        </td>

        <!-- Subscription Period -->
        <td>
          <div class="flex flex-col">
            <span class="text-sm text-zinc-900 dark:text-white">
              {{ client.subscriptionStartDate | date: 'dd/MM/yyyy' }}
            </span>
            <span class="text-xs text-zinc-500 dark:text-zinc-400">
              hasta {{ client.subscriptionEndDate | date: 'dd/MM/yyyy' }}
            </span>
          </div>
        </td>

        <!-- Created Date -->
        <td>
          <span class="text-sm text-zinc-600 dark:text-zinc-400">
            {{ client.createdAt | date: 'dd/MM/yyyy' }}
          </span>
        </td>

        <!-- Actions -->
        <td>
          <div class="flex justify-center">
            <p-button
              (click)="showActionMenu($event, client, actionMenu)"
              icon="pi pi-ellipsis-v"
              [rounded]="true"
              [outlined]="true"
              size="small"
              severity="secondary"
              pTooltip="Acciones"
              tooltipPosition="top"
              [appendTo]="'body'"
            />
          </div>
        </td>
      </tr>
    </ng-template>

    <!-- Empty State -->
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="7" class="text-center py-8">
          <orca-empty-state
            icon="sailing"
            iconSeverity="info"
            title="No se encontraron clientes"
            [message]="
              searchTerm() || selectedStatus()
                ? 'Intente ajustar los filtros de búsqueda.'
                : 'Navegue hacia nuevos horizontes creando su primer cliente.'
            "
            [showActionButton]="!searchTerm() && !selectedStatus()"
            actionButtonLabel="Crear Primer Cliente"
            actionButtonIcon="pi pi-plus"
            context="info"
            (actionClick)="openCreateClientModal()"
          />
        </td>
      </tr>
    </ng-template>
  </p-table>

  <!-- Action Menu (Global) -->
  <p-menu #actionMenu [model]="menuItems()" [popup]="true" />

  <!-- Confirmation Dialog -->
  <p-confirmDialog [style]="{ width: '450px' }" />
</div>
